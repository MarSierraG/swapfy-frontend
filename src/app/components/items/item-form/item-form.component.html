<div class="mobile-product-page">
  <div class="image-container text-center">
    <!-- Si hay imagen nueva, mostrarla -->
    <ng-container *ngIf="nuevaImagenSeleccionada; else fallback">
      <img [src]="nuevaImagenSeleccionada" alt="Vista previa" class="main-image mb-3" />
    </ng-container>

    <!-- Si no hay imagen nueva -->
    <ng-template #fallback>
      <!-- Si estás editando y hay imagen original -->
      <ng-container *ngIf="modo === 'editar' && formItem.imageUrl; else sinImagen">
        <img [src]="formItem.imageUrl" alt="Imagen original" class="main-image mb-3" />
      </ng-container>

      <!-- Si no hay ninguna imagen -->
      <ng-template #sinImagen>
        <div class="fallback-image">
          <i class="bi bi-image fs-1 me-2"></i> Sin imagen
        </div>
      </ng-template>
    </ng-template>

    <!-- Input para subir imagen (siempre visible) -->
    <div class="upload-wrapper mt-2">
      <label for="imagen" class="upload-label">
        <i class="bi bi-upload me-2 fs-4"></i> Cambiar imagen
      </label>
      <input
        id="imagen"
        type="file"
        accept="image/*"
        (change)="onImageChange($event)"
        class="upload-input visually-hidden" />
      <div *ngIf="mostrarErrores && modo === 'crear' && !selectedImageFile" class="text-danger mt-1">
        Debes subir una imagen.
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <div class="info-wrapper">
    <form (ngSubmit)="onGuardar()" #form="ngForm" novalidate>
      <!-- Título -->
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-fonts"></i> Título</label>
        <input [(ngModel)]="formItem.title" name="title" type="text" class="form-control editable-active" required />
        <div *ngIf="mostrarErrores && !formItem.title.trim()" class="text-danger mt-1">
          El título es obligatorio.
        </div>
      </div>

      <!-- Descripción -->
      <div class="mb-3">
        <label class="form-label"><i class="bi bi-card-text"></i> Descripción</label>
        <textarea [(ngModel)]="formItem.description" name="description" class="form-control editable-active" rows="3" required></textarea>
        <div *ngIf="mostrarErrores && !formItem.description.trim()" class="text-danger mt-1">
          La descripción es obligatoria.
        </div>
      </div>

      <!-- Créditos -->
      <div class="mb-4">
        <label class="form-label"><i class="bi bi-cash-coin text-warning"></i> Créditos</label>
        <input
          [(ngModel)]="formItem.creditValue"
          name="creditValue"
          type="number"
          class="form-control editable-active input-credito"
          min="0"
          required />
        <div *ngIf="mostrarErrores && formItem.creditValue <= 0" class="text-danger mt-1">
          Debes asignar al menos 1 crédito.
        </div>
      </div>

      <!-- Tipo y Estado -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label"><i class="bi bi-arrow-left-right"></i> Tipo</label>
          <select [(ngModel)]="formItem.type" name="type" class="form-select editable-active" required>
            <option value="offer">Oferta</option>
            <option value="demand">Demanda</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="bi bi-check2-circle"></i> Estado</label>
          <select [(ngModel)]="formItem.status" name="status" class="form-select editable-active" required>
            <option value="Available">Disponible</option>
            <option value="Unavailable">No disponible</option>
          </select>
        </div>
      </div>

      <!-- Etiquetas -->
      <div class="mb-5">
        <label class="form-label"><i class="bi bi-tags-fill"></i> Etiquetas</label>
        <div class="row">
          <div class="col-6" *ngFor="let tag of tagsDisponibles; let i = index">
            <div class="form-check">
              <input
                type="checkbox"
                class="form-check-input"
                [id]="'tag-' + tag.tagId"
                [checked]="formItem.tags.includes(tag.tagId)"
                (change)="onTagCheckboxChange($event, tag.tagId)" />
              <label class="form-check-label" [for]="'tag-' + tag.tagId">{{ tag.name }}</label>
            </div>
          </div>
        </div>


        <div *ngIf="mostrarErrores && formItem.tags.length === 0" class="text-danger mt-1">
          Debes seleccionar al menos una etiqueta.
        </div>
      </div>

      <!-- Botones -->
      <div class="d-grid mt-4">
        <button
          class="btn rounded-pill py-2 text-white d-flex align-items-center justify-content-center gap-2 position-relative"
          type="submit"
          [disabled]="isLoading"
          style="background-color: darkcyan; border: none; min-height: 48px;">

          <ng-container>
            <i class="bi bi-check-circle me-1"></i>
            {{ modo === 'editar' ? 'Guardar cambios' : 'Crear artículo' }}
          </ng-container>

        </button>
      </div>



      <div *ngIf="modo === 'editar'" class="d-grid mt-2">
        <button class="btn btn-outline-secondary rounded-pill py-2" type="button" (click)="onCancelar()">
          <i class="bi bi-x-circle me-1"></i> Cancelar
        </button>
      </div>
    </form>
  </div>
</div>
